<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Control Tower - AI Agent Monitor</title>
<style>
* { 
  margin: 0; 
  padding: 0; 
  box-sizing: border-box; 
  -webkit-tap-highlight-color: transparent;
}

/* Midnight Premium - Command Center Theme */
:root {
  --primary: #6366F1;
  --primary-light: #818CF8;
  --secondary: #EC4899;
  --accent: #10B981;
  --surface: #0F0F0F;
  --surface-elevated: #1A1A1A;
  --surface-card: #1C1C1E;
  --text-primary: #FAFAFA;
  --text-secondary: #A1A1AA;
  --text-muted: #71717A;
  --border: #27272A;
  --success: #10B981;
  --warning: #F59E0B;
  --error: #EF4444;
  
  --glow-primary: 0 0 20px rgba(99, 102, 241, 0.4);
  --glow-secondary: 0 0 20px rgba(236, 72, 153, 0.4);
  --glow-accent: 0 0 15px rgba(16, 185, 129, 0.4);
  
  --font-mono: 'SF Mono', 'Fira Code', 'Consolas', monospace;
  --font-display: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
}

/* Light Mode */
[data-theme="light"] {
  --surface: #FFFFFF;
  --surface-elevated: #F9FAFB;
  --surface-card: #FFFFFF;
  --text-primary: #111827;
  --text-secondary: #6B7280;
  --text-muted: #9CA3AF;
  --border: #E5E7EB;
  --glow-primary: 0 0 20px rgba(99, 102, 241, 0.15);
  --glow-secondary: 0 0 20px rgba(236, 72, 153, 0.15);
  --glow-accent: 0 0 15px rgba(16, 185, 129, 0.15);
}

[data-theme="light"] .command-bar {
  background: linear-gradient(135deg, #FFFFFF 0%, #F9FAFB 100%);
  border-bottom: 2px solid var(--primary);
  box-shadow: 0 4px 20px rgba(99, 102, 241, 0.1);
}

[data-theme="light"] .terminal-feed {
  background: #F3F4F6;
  color: var(--text-primary);
}

[data-theme="light"] .terminal-timestamp {
  color: var(--text-muted);
}

[data-theme="light"] .terminal-content {
  color: var(--text-primary);
}

body {
  font-family: var(--font-display);
  background: var(--surface);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
}

/* Top Command Bar */
.command-bar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 60px;
  background: linear-gradient(135deg, #0F0F0F 0%, #1A1A1A 100%);
  border-bottom: 2px solid var(--primary);
  box-shadow: 0 4px 20px rgba(99, 102, 241, 0.2);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 1.5rem;
  z-index: 100;
}

.command-logo {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.command-logo-icon {
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  box-shadow: var(--glow-primary);
  animation: pulse-glow 3s ease-in-out infinite;
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: var(--glow-primary); }
  50% { box-shadow: 0 0 30px rgba(99, 102, 241, 0.6); }
}

.command-logo-text {
  font-size: 1.125rem;
  font-weight: 700;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  background: linear-gradient(135deg, var(--primary-light), var(--secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.command-status {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: var(--surface-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  font-family: var(--font-mono);
  font-size: 0.75rem;
}

.status-indicator {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--success);
  box-shadow: var(--glow-accent);
  animation: blink 2s ease-in-out infinite;
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

/* Main Layout */
.main-container {
  margin-top: 60px;
  padding: 1.5rem;
  max-width: 1400px;
  margin-left: auto;
  margin-right: auto;
}

/* Hexagonal Stats Grid */
.hex-stats {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 0.75rem;
  margin-bottom: 1.5rem;
  max-width: 400px;
}

.hex-stat {
  position: relative;
  aspect-ratio: 1;
  background: linear-gradient(135deg, var(--surface-card) 0%, var(--surface-elevated) 100%);
  clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  border: 2px solid var(--border);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  cursor: pointer;
}

.hex-stat:hover {
  transform: scale(1.05);
  border-color: var(--primary);
  box-shadow: var(--glow-primary);
}

.hex-stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  font-family: var(--font-mono);
  line-height: 1;
  margin-bottom: 0.25rem;
}

.hex-stat-value.primary {
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.hex-stat-value.accent {
  color: var(--accent);
}

.hex-stat-value.secondary {
  background: linear-gradient(135deg, var(--secondary), var(--primary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.hex-stat-label {
  font-size: 0.6875rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-muted);
  font-weight: 600;
}

/* Terminal Activity Feed */
.terminal-section {
  margin-bottom: 2rem;
}

.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--border);
}

.section-title {
  font-size: 1rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--primary-light);
  font-family: var(--font-mono);
}

.refresh-btn {
  padding: 0.5rem 1rem;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 0.875rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  font-family: var(--font-mono);
}

.refresh-btn:hover {
  background: var(--primary-light);
  box-shadow: var(--glow-primary);
}

.refresh-btn:active {
  transform: scale(0.95);
}

.terminal-feed {
  background: #000000;
  border: 2px solid var(--primary);
  border-radius: 8px;
  padding: 1rem;
  font-family: var(--font-mono);
  font-size: 0.875rem;
  line-height: 1.6;
  max-height: 400px;
  overflow-y: auto;
  box-shadow: 0 0 30px rgba(99, 102, 241, 0.2);
}

.terminal-feed::-webkit-scrollbar {
  width: 8px;
}

.terminal-feed::-webkit-scrollbar-track {
  background: #0F0F0F;
}

.terminal-feed::-webkit-scrollbar-thumb {
  background: var(--primary);
  border-radius: 4px;
}

.terminal-line {
  margin-bottom: 0.5rem;
  display: flex;
  gap: 0.75rem;
}

.terminal-timestamp {
  color: var(--text-muted);
  flex-shrink: 0;
}

.terminal-content {
  color: var(--text-primary);
}

.terminal-session-key {
  color: var(--accent);
}

.terminal-status-active {
  color: var(--success);
}

.terminal-status-idle {
  color: var(--warning);
}

/* Session Monitor Grid */
.session-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 1rem;
}

.session-monitor-card {
  background: linear-gradient(135deg, var(--surface-card), var(--surface-elevated));
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 1rem;
  transition: all 0.3s;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.session-monitor-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
  opacity: 0;
  transition: opacity 0.3s;
}

.session-monitor-card:hover {
  border-color: var(--primary);
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
}

.session-monitor-card:hover::before {
  opacity: 1;
}

.session-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 0.75rem;
}

.session-kind-badge {
  padding: 0.25rem 0.75rem;
  border-radius: 12px;
  font-size: 0.625rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  font-family: var(--font-mono);
}

.session-kind-badge.main {
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  color: white;
  box-shadow: var(--glow-primary);
}

.session-kind-badge.isolated {
  background: var(--accent);
  color: white;
  box-shadow: var(--glow-accent);
}

.session-info h3 {
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 0.25rem;
}

.session-key {
  font-family: var(--font-mono);
  font-size: 0.75rem;
  color: var(--text-muted);
}

.session-metrics {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0.5rem;
  margin-top: 0.75rem;
  padding-top: 0.75rem;
  border-top: 1px solid var(--border);
}

.metric {
  display: flex;
  flex-direction: column;
}

.metric-label {
  font-size: 0.625rem;
  text-transform: uppercase;
  color: var(--text-muted);
  letter-spacing: 0.05em;
  margin-bottom: 0.25rem;
}

.metric-value {
  font-family: var(--font-mono);
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--primary-light);
}

/* Loading State */
.loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 3rem;
  color: var(--text-muted);
}

.spinner {
  width: 48px;
  height: 48px;
  border: 4px solid var(--border);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-bottom: 1rem;
  box-shadow: var(--glow-primary);
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Empty State */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 3rem;
  text-align: center;
  color: var(--text-muted);
}

.empty-icon {
  font-size: 4rem;
  margin-bottom: 1rem;
  opacity: 0.3;
}

.empty-title {
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 0.5rem;
}

@media (max-width: 768px) {
  .hex-stats {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .session-grid {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body>

<!-- Top Command Bar -->
<div class="command-bar">
  <div class="command-logo">
    <div class="command-logo-icon">‚ö°</div>
    <div class="command-logo-text">Control Tower</div>
  </div>
  <div style="display: flex; align-items: center; gap: 1rem;">
    <button id="themeToggle" style="width: 44px; height: 44px; border-radius: 50%; background: var(--surface-card); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.25rem; transition: all 0.2s;">
      <span id="themeIcon">‚òÄÔ∏è</span>
    </button>
    <div class="command-status">
      <div class="status-indicator"></div>
      <span id="statusText">SYSTEM ONLINE</span>
    </div>
  </div>
</div>

<!-- Main Container -->
<div class="main-container">
  
  <!-- Hexagonal Stats -->
  <div class="hex-stats">
    <div class="hex-stat">
      <div class="hex-stat-value primary" id="sessionCount">-</div>
      <div class="hex-stat-label">Sessions</div>
    </div>
    <div class="hex-stat">
      <div class="hex-stat-value accent" id="messageCount">-</div>
      <div class="hex-stat-label">Messages</div>
    </div>
    <div class="hex-stat">
      <div class="hex-stat-value secondary" id="activeCount">-</div>
      <div class="hex-stat-label">Active</div>
    </div>
    <div class="hex-stat">
      <div class="hex-stat-value" id="tokenCount">-</div>
      <div class="hex-stat-label">Tokens</div>
    </div>
  </div>

  <!-- Terminal Activity Feed -->
  <div class="terminal-section">
    <div class="section-header">
      <div class="section-title">// ACTIVITY_STREAM</div>
      <button class="refresh-btn" onclick="refreshSessions()">REFRESH</button>
    </div>
    <div class="terminal-feed" id="terminalFeed">
      <div class="loading">
        <div class="spinner"></div>
        <p>Initializing monitoring systems...</p>
      </div>
    </div>
  </div>

  <!-- Session Monitor Grid -->
  <div class="terminal-section">
    <div class="section-header">
      <div class="section-title">// SESSION_MONITOR</div>
    </div>
    <div id="sessionGrid">
      <div class="loading">
        <div class="spinner"></div>
        <p>Loading session data...</p>
      </div>
    </div>
  </div>

</div>

<script>
// API Configuration
const API_BASE = window.location.hostname === 'localhost' 
  ? 'http://localhost:3000/api'
  : '/.netlify/functions';

// Fetch Sessions
async function fetchSessions() {
  try {
    const response = await fetch(`${API_BASE}/sessions`);
    if (!response.ok) throw new Error('Failed to fetch sessions');
    const data = await response.json();
    return data.sessions || [];
  } catch (error) {
    console.error('Error fetching sessions:', error);
    return [];
  }
}

// Render Terminal Feed
function renderTerminalFeed(sessions) {
  const feed = document.getElementById('terminalFeed');
  const now = new Date();
  
  const lines = sessions.flatMap(session => {
    const lastActive = new Date(session.lastActiveAt);
    const diffMs = now - lastActive;
    const diffMins = Math.floor(diffMs / 60000);
    const isActive = diffMins < 10;
    
    return [
      `<div class="terminal-line">
        <span class="terminal-timestamp">[${lastActive.toLocaleTimeString()}]</span>
        <span class="terminal-content">
          SESSION <span class="terminal-session-key">${session.sessionKey.slice(0, 12)}</span> 
          <span class="terminal-status-${isActive ? 'active' : 'idle'}">${isActive ? 'ACTIVE' : 'IDLE'}</span>
          | ${session.messageCount || 0} msgs | ${formatNumber(session.tokenCount || 0)} tokens
        </span>
      </div>`
    ];
  });
  
  feed.innerHTML = lines.join('') || '<div class="empty-state"><div class="empty-icon">üì°</div><div class="empty-title">No activity detected</div></div>';
}

// Render Session Grid
function renderSessionGrid(sessions) {
  const container = document.getElementById('sessionGrid');
  
  if (!sessions || sessions.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üí§</div>
        <div class="empty-title">No Active Sessions</div>
        <p>Monitoring systems standby...</p>
      </div>
    `;
    return;
  }

  container.innerHTML = `
    <div class="session-grid">
      ${sessions.map(session => `
        <div class="session-monitor-card">
          <div class="session-header">
            <div class="session-info">
              <h3>${session.label || 'Unnamed Session'}</h3>
              <div class="session-key">${session.sessionKey}</div>
            </div>
            <div class="session-kind-badge ${session.kind}">${session.kind}</div>
          </div>
          <div class="session-metrics">
            <div class="metric">
              <div class="metric-label">Messages</div>
              <div class="metric-value">${session.messageCount || 0}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Tokens</div>
              <div class="metric-value">${formatNumber(session.tokenCount || 0)}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Model</div>
              <div class="metric-value">${session.model || 'default'}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Last Active</div>
              <div class="metric-value">${formatTime(session.lastActiveAt)}</div>
            </div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

// Update Stats
function updateStats(sessions) {
  const sessionCount = sessions.length;
  const messageCount = sessions.reduce((sum, s) => sum + (s.messageCount || 0), 0);
  const activeCount = sessions.filter(s => isActiveRecently(s.lastActiveAt)).length;
  const tokenCount = sessions.reduce((sum, s) => sum + (s.tokenCount || 0), 0);

  document.getElementById('sessionCount').textContent = sessionCount;
  document.getElementById('messageCount').textContent = messageCount;
  document.getElementById('activeCount').textContent = activeCount;
  document.getElementById('tokenCount').textContent = formatNumber(tokenCount);
  document.getElementById('statusText').textContent = `${activeCount} ACTIVE ‚Ä¢ ${sessionCount} TOTAL`;
}

// Helpers
function isActiveRecently(timestamp) {
  if (!timestamp) return false;
  const now = Date.now();
  const lastActive = new Date(timestamp).getTime();
  return (now - lastActive) < 10 * 60 * 1000;
}

function formatTime(timestamp) {
  if (!timestamp) return 'Unknown';
  const date = new Date(timestamp);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  
  if (diffMins < 1) return 'Now';
  if (diffMins < 60) return `${diffMins}m`;
  const diffHours = Math.floor(diffMins / 60);
  if (diffHours < 24) return `${diffHours}h`;
  const diffDays = Math.floor(diffHours / 24);
  return `${diffDays}d`;
}

function formatNumber(num) {
  if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
  if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
  return num.toString();
}

async function refreshSessions() {
  document.getElementById('sessionGrid').innerHTML = `
    <div class="loading">
      <div class="spinner"></div>
      <p>Refreshing session data...</p>
    </div>
  `;
  
  const sessions = await fetchSessions();
  renderTerminalFeed(sessions);
  renderSessionGrid(sessions);
  updateStats(sessions);
}

// Theme Toggle
const themeToggle = document.getElementById('themeToggle');
const themeIcon = document.getElementById('themeIcon');
const body = document.body;

let currentTheme = localStorage.getItem('controlTowerTheme') || 'dark';
body.setAttribute('data-theme', currentTheme);
themeIcon.textContent = currentTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';

themeToggle.addEventListener('click', () => {
  currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
  body.setAttribute('data-theme', currentTheme);
  themeIcon.textContent = currentTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem('controlTowerTheme', currentTheme);
});

// Initial Load
(async function init() {
  const sessions = await fetchSessions();
  renderTerminalFeed(sessions);
  renderSessionGrid(sessions);
  updateStats(sessions);
  
  // Auto-refresh every 30 seconds
  setInterval(async () => {
    const sessions = await fetchSessions();
    renderTerminalFeed(sessions);
    renderSessionGrid(sessions);
    updateStats(sessions);
  }, 30000);
})();
</script>

</body>
</html>
